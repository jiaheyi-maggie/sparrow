<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    </head>
    <body>
        <button id="link-button">Link Bank Accounts</button>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
        <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
        <script type="text/javascript">
            (async function($) {

                const fetchLinkToken = async () => {
                    const response = await fetch('/create_link_token')
                        .catch((error) => {
                            console.log(error)
                        });

                    const { linkToken } = await response.json()
                        .catch((error) => {
                            console.log(error)
                        });
                    
                    return linkToken;
                };
                
                // link flow
                const handler = Plaid.create({
                    token: await fetchLinkToken(),
                    onSuccess: async (publicToken, metadata) => {
                        console.log(publicToken);
                        console.log(metadata);

                        // send public token to the front end for exchanging
                        // $.post('/plaid_token_exchange', {
                        //     public_token: public_token,
                        //     accounts: metadata.accounts,
                        //     institution: metadata.institution,
                        //     link_session_id: metadata.link_session_id,
                        // })

                        await fetch('/plaid_token_exchange', {
                            method: 'POST',
                            body: JSON.stringify({ publicToken }),
                            // letting the api know that the data is coming in with JSON payload
                            headers: {
                                'Content-Type' : "application/json",
                            },
                        });
                    },
                    onLoad: () => {},
                    onExit: async (err, metadata) => {
                        console.log(err);
                        console.log(metadata);
                    },
                    onEvent: async (eventName, metadata) =>  {
                        console.log(metadata);
                    },
                    receivedRedirectUri: null
                })

                // actions when button is clicked
                $('#link-button').on('click', function(e) { handler.open();});
            })(jQuery);
        </script>
    </body>

</html>